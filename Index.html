<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBU Tutor Platform - Essay Simulation Builder</title>
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-dark: #1e3d72;
            --secondary: #f8f9fa;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --border: #dee2e6;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .header p {
            text-align: center;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .card-header {
            background: var(--secondary);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-header h2 {
            margin: 0;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
            gap: 0.5rem;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .steps-container {
            border: 1px solid var(--border);
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .step-card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .step-number {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        .step-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option-radio {
            margin: 0;
        }
        
        .option-input {
            flex: 1;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .table th {
            background: var(--secondary);
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tbody tr:hover {
            background: var(--light);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid transparent;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning);
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: var(--info);
            color: #0c5460;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d;
        }
        
        .simulation-id {
            font-family: monospace;
            background: var(--light);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.875rem;
        }
        
        .auth-required {
            text-align: center;
            padding: 3rem;
        }
        
        .auth-required h2 {
            color: var(--danger);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Essay Simulation Builder</h1>
            <p>Create and manage guided essay simulations for the CBU Tutor Platform</p>
            <div class="user-info" id="userInfo">
                <div class="loading"></div> Checking authentication...
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Authentication Required View -->
        <div id="authRequiredView" class="hidden">
            <div class="card">
                <div class="auth-required">
                    <h2>Authentication Required</h2>
                    <p>You must be logged in with a valid tutor account to access this system.</p>
                    <div class="alert alert-warning">
                        <strong>Please ensure:</strong>
                        <ul style="text-align: left; margin-top: 0.5rem;">
                            <li>You are logged into your Google account</li>
                            <li>Your email is registered in the Tutors sheet</li>
                            <li>Your account is marked as active (IsActive = TRUE)</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="checkAuthentication()">
                        <div class="loading"></div> Retry Authentication
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2>Essay Simulations</h2>
                        <button class="btn btn-primary" onclick="showCreateForm()">
                            <span>+ Create New Simulation</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search simulations by title, course, or topic..." onkeyup="filterSimulations()">
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="simulationsTable">
                            <thead>
                                <tr>
                                    <th>Simulation ID</th>
                                    <th>Course/Term</th>
                                    <th>Topic</th>
                                    <th>Title</th>
                                    <th>Steps</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="simulationsTableBody">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingIndicator" class="text-center mt-4">
                        <div class="loading"></div>
                        <p class="text-muted">Loading simulations...</p>
                    </div>
                    <div id="noSimulations" class="hidden text-center mt-4">
                        <p class="text-muted">No essay simulations found. Create your first one to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Creation/Edit Form -->
        <div id="formView" class="hidden">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 id="formTitle">Create New Essay Simulation</h2>
                        <button class="btn btn-outline" onclick="showDashboard()">
                            <span>‚Üê Back to Dashboard</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Stage 1: Header Form -->
                    <div id="headerForm">
                        <div class="alert alert-info">
                            <strong>Stage 1:</strong> First, define the basic information about your essay simulation.
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="courseSelect">Course *</label>
                            <select class="form-control form-select" id="courseSelect" required>
                                <option value="">Select a course</option>
                                <option value="BI110">BI110 - Biology</option>
                                <option value="CS110">CS110 - Computer Science</option>
                                <option value="MA110">MA110 - Mathematics</option>
                                <option value="CH110">CH110 - Chemistry</option>
                                <option value="PH110">PH110 - Physics</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="termSelect">Term *</label>
                            <select class="form-control form-select" id="termSelect" required>
                                <option value="">Select a term</option>
                                <option value="T1">Term 1</option>
                                <option value="T2">Term 2</option>
                                <option value="ALL">All Terms</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="topicInput">Topic *</label>
                            <input type="text" class="form-control" id="topicInput" placeholder="e.g., Cell Biology, Programming Basics" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="titleInput">Essay Title/Prompt *</label>
                            <textarea class="form-control" id="titleInput" rows="3" placeholder="Enter the main essay question or prompt that students will answer..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="durationInput">Estimated Duration (minutes) *</label>
                            <input type="number" class="form-control" id="durationInput" min="5" max="180" value="25" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="tutorIdInput">Tutor ID *</label>
                            <input type="text" class="form-control" id="tutorIdInput" readonly style="background-color: #f8f9fa;">
                            <small class="text-muted">Automatically set from your authenticated account</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="tagsInput">Tags</label>
                            <input type="text" class="form-control" id="tagsInput" placeholder="Optional tags for categorization (comma-separated)">
                        </div>
                        
                        <div class="flex gap-4">
                            <button class="btn btn-primary" id="saveHeaderBtn" onclick="saveSimulationHeader()">
                                <span>Save Header & Continue to Steps ‚Üí</span>
                            </button>
                            <button class="btn btn-outline" onclick="showDashboard()">
                                <span>Cancel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Stage 2: Steps Form -->
                    <div id="stepsForm" class="hidden">
                        <div class="alert alert-success">
                            <strong>Stage 2:</strong> Now build the guided steps for your essay simulation. 
                            <span id="editingSimulationId" class="simulation-id"></span>
                        </div>
                        
                        <div class="steps-container" id="stepsContainer">
                            <!-- Dynamic step cards will be added here -->
                        </div>
                        
                        <div class="flex gap-4 mt-4">
                            <button class="btn btn-outline" onclick="addStep()">
                                <span>+ Add New Step</span>
                            </button>
                            <button class="btn btn-success" id="saveStepsBtn" onclick="saveAllSteps()">
                                <span>Save All Steps</span>
                            </button>
                            <button class="btn btn-outline" onclick="showDashboard()">
                                <span>Cancel</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THIS WITH YOUR DEPLOYED APPS SCRIPT URL
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwlGsGNKGZxDH7l_W7wKJnFPKFsWiE_HA0RaIg3_JGM1D2ub18jLpsOXfG0K-5ifgHt/exec';
        
        // Global state
        let currentUser = null;
        let currentEditingSimulationId = null;
        let allSimulations = [];
        let stepCounter = 0;

        // DOM Elements
        const elements = {
            authRequiredView: document.getElementById('authRequiredView'),
            dashboardView: document.getElementById('dashboardView'),
            formView: document.getElementById('formView'),
            headerForm: document.getElementById('headerForm'),
            stepsForm: document.getElementById('stepsForm'),
            simulationsTableBody: document.getElementById('simulationsTableBody'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            noSimulations: document.getElementById('noSimulations'),
            stepsContainer: document.getElementById('stepsContainer'),
            formTitle: document.getElementById('formTitle'),
            editingSimulationId: document.getElementById('editingSimulationId'),
            saveHeaderBtn: document.getElementById('saveHeaderBtn'),
            saveStepsBtn: document.getElementById('saveStepsBtn'),
            userInfo: document.getElementById('userInfo')
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Essay Simulation Builder initializing...');
            checkAuthentication();
        });

        // Authentication Management
        async function checkAuthentication() {
            console.log('üîê Checking authentication...');
            showLoading(true);
            
            try {
                const response = await callBackend('testBackend', {}, 'GET');
                console.log('üì¶ Authentication response:', response);
                
                if (response.success) {
                    currentUser = {
                        email: response.authenticatedUser,
                        tutorId: response.authenticatedTutorID
                    };
                    
                    // Update UI for authenticated user
                    elements.userInfo.innerHTML = `Logged in as: <strong>${currentUser.email}</strong> (Tutor ID: <strong>${currentUser.tutorId}</strong>)`;
                    document.getElementById('tutorIdInput').value = currentUser.tutorId;
                    
                    // Show dashboard
                    elements.authRequiredView.classList.add('hidden');
                    elements.dashboardView.classList.remove('hidden');
                    
                    console.log('‚úÖ Authentication successful:', currentUser);
                    loadSimulations();
                    
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('‚ùå Authentication failed:', error);
                elements.userInfo.innerHTML = `Authentication failed: ${error.message}`;
                elements.authRequiredView.classList.remove('hidden');
                elements.dashboardView.classList.add('hidden');
                showAlert('error', `Authentication failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // View Management
        function showDashboard() {
            console.log('üìä Switching to Dashboard view');
            elements.dashboardView.classList.remove('hidden');
            elements.formView.classList.add('hidden');
            resetForm();
            loadSimulations();
        }

        function showCreateForm() {
            console.log('üìù Switching to Create form');
            elements.dashboardView.classList.add('hidden');
            elements.formView.classList.remove('hidden');
            elements.headerForm.classList.remove('hidden');
            elements.stepsForm.classList.add('hidden');
            elements.formTitle.textContent = 'Create New Essay Simulation';
            currentEditingSimulationId = null;
            resetForm();
        }

        function showStepsForm(simulationId) {
            console.log('üîÑ Transitioning to Steps form for:', simulationId);
            
            elements.headerForm.classList.add('hidden');
            elements.stepsForm.classList.remove('hidden');
            elements.editingSimulationId.textContent = simulationId;
            currentEditingSimulationId = simulationId;
            
            if (elements.stepsContainer.children.length === 0) {
                console.log('‚ûï Adding initial step');
                addStep();
            }
            
            console.log('‚úÖ Steps form ready. Current simulation ID:', currentEditingSimulationId);
        }

        function showEditForm(simulationId) {
            console.log('‚úèÔ∏è Loading edit form for:', simulationId);
            elements.dashboardView.classList.add('hidden');
            elements.formView.classList.remove('hidden');
            elements.headerForm.classList.remove('hidden');
            elements.stepsForm.classList.add('hidden');
            elements.formTitle.textContent = 'Edit Essay Simulation';
            loadSimulationForEditing(simulationId);
        }

        // Data Management
        async function loadSimulations() {
            console.log('üì• Loading simulations...');
            showLoading(true);
            
            try {
                const response = await callBackend('getAllEssaySimulations', {}, 'GET');
                console.log('üì¶ Simulations response:', response);
                
                if (response.success) {
                    allSimulations = response.data || [];
                    console.log(`‚úÖ Loaded ${allSimulations.length} simulations`);
                    displaySimulations(allSimulations);
                } else {
                    console.error('‚ùå Failed to load simulations:', response.error);
                    showAlert('error', `Failed to load simulations: ${response.error}`);
                }
            } catch (error) {
                console.error('‚ùå Network error loading simulations:', error);
                showAlert('error', `Network error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displaySimulations(simulations) {
            const tbody = elements.simulationsTableBody;
            tbody.innerHTML = '';
            
            if (simulations.length === 0) {
                elements.noSimulations.classList.remove('hidden');
                console.log('‚ÑπÔ∏è No simulations found');
                return;
            }
            
            elements.noSimulations.classList.add('hidden');
            console.log(`üìä Displaying ${simulations.length} simulations`);
            
            simulations.forEach(sim => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div class="simulation-id">${sim.SimulationID}</div>
                        <small class="text-muted">v${sim.Version || '1.0'}</small>
                    </td>
                    <td>${sim.Course} / ${sim.Term}</td>
                    <td>${sim.Topic}</td>
                    <td>
                        <strong>${sim.Title}</strong>
                        ${sim.Tags ? `<br><small class="text-muted">${sim.Tags}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge badge-info">${sim.StepCount} steps</span>
                    </td>
                    <td>${sim.FormattedDuration || sim.EstimatedDuration + ' min'}</td>
                    <td>
                        <div class="flex gap-4">
                            <button class="btn btn-outline btn-sm" onclick="showEditForm('${sim.SimulationID}')">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSimulation('${sim.SimulationID}')">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        async function loadSimulationForEditing(simulationId) {
            console.log('üì• Loading simulation data for editing:', simulationId);
            showLoading(true);
            
            try {
                const response = await callBackend('getEssaySimulationById', { simulationId }, 'POST');
                console.log('üì¶ Edit data response:', response);
                
                if (response.success) {
                    const { header, steps } = response.data;
                    currentEditingSimulationId = simulationId;
                    
                    // Populate header form
                    document.getElementById('courseSelect').value = header.Course;
                    document.getElementById('termSelect').value = header.Term;
                    document.getElementById('topicInput').value = header.Topic;
                    document.getElementById('titleInput').value = header.Title;
                    document.getElementById('durationInput').value = header.EstimatedDuration;
                    document.getElementById('tutorIdInput').value = header.TutorID;
                    document.getElementById('tagsInput').value = header.Tags || '';
                    
                    // Clear and populate steps
                    elements.stepsContainer.innerHTML = '';
                    stepCounter = 0;
                    
                    if (steps && steps.length > 0) {
                        console.log(`‚ûï Loading ${steps.length} steps`);
                        steps.forEach(step => {
                            addStep(step);
                        });
                    }
                    
                    console.log('üîÑ Transitioning to steps form for editing');
                    showStepsForm(simulationId);
                } else {
                    console.error('‚ùå Failed to load simulation:', response.error);
                    showAlert('error', `Failed to load simulation: ${response.error}`);
                }
            } catch (error) {
                console.error('‚ùå Network error loading simulation:', error);
                showAlert('error', `Network error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Form Operations
        async function saveSimulationHeader() {
            console.log('üíæ Saving simulation header...');
            const btn = elements.saveHeaderBtn;
            const originalText = btn.innerHTML;
            
            if (!validateHeaderForm()) {
                console.log('‚ùå Header form validation failed');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Processing...';
            
            try {
                const formData = {
                    Course: document.getElementById('courseSelect').value,
                    Term: document.getElementById('termSelect').value,
                    Topic: document.getElementById('topicInput').value,
                    Title: document.getElementById('titleInput').value,
                    EstimatedDuration: parseInt(document.getElementById('durationInput').value),
                    TutorID: currentUser.tutorId, // Use authenticated tutor ID
                    Tags: document.getElementById('tagsInput').value
                };
                
                if (currentEditingSimulationId) {
                    formData.SimulationID = currentEditingSimulationId;
                }
                
                console.log('üì§ Sending header data:', formData);
                const response = await callBackend('createOrUpdateSimulationHeader', formData);
                console.log('üì¶ Header save response:', response);
                
                if (response.success) {
                    console.log('‚úÖ Header saved successfully, transitioning to steps');
                    showAlert('success', response.message);
                    
                    // Force UI update before transition
                    await new Promise(resolve => setTimeout(resolve, 100));
                    showStepsForm(response.id);
                    
                } else {
                    console.error('‚ùå Header save failed:', response.error);
                    
                    if (response.error.includes('Authentication')) {
                        showAlert('error', 'Authentication failed. Please refresh the page.');
                        checkAuthentication();
                    } else if (response.error.includes('TutorID mismatch')) {
                        showAlert('error', 'Tutor ID mismatch. Please use your assigned Tutor ID.');
                    } else {
                        showAlert('error', `Failed to save header: ${response.error}`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Network error saving header:', error);
                showAlert('error', `Network error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function saveAllSteps() {
            console.log('üíæ Saving all steps...');
            const btn = elements.saveStepsBtn;
            const originalText = btn.innerHTML;
            
            const steps = collectStepsData();
            if (steps.length === 0) {
                console.log('‚ùå No steps to save');
                showAlert('error', 'Please add at least one step');
                return;
            }
            
            if (!validateAllSteps()) {
                console.log('‚ùå Steps validation failed');
                showAlert('error', 'Please complete all steps before saving');
                return;
            }
            
            console.log(`üì§ Preparing to save ${steps.length} steps`);
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Saving Steps...';
            
            try {
                const response = await callBackend('saveSimulationSteps', {
                    simulationId: currentEditingSimulationId,
                    steps: steps
                });
                
                console.log('üì¶ Steps save response:', response);
                
                if (response.success) {
                    console.log('‚úÖ All steps saved successfully');
                    showAlert('success', response.message);
                    
                    setTimeout(() => {
                        showDashboard();
                    }, 1500);
                } else {
                    console.error('‚ùå Steps save failed:', response.error);
                    showAlert('error', `Failed to save steps: ${response.error}`);
                }
            } catch (error) {
                console.error('‚ùå Network error saving steps:', error);
                showAlert('error', `Network error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function addStep(stepData = null) {
            stepCounter++;
            const stepId = `step_${stepCounter}`;
            
            console.log(`‚ûï Adding step ${stepCounter}`, stepData ? '(with data)' : '(new)');
            
            const stepCard = document.createElement('div');
            stepCard.className = 'step-card';
            stepCard.id = stepId;
            
            stepCard.innerHTML = `
                <div class="step-header">
                    <div class="step-number">${stepCounter}</div>
                    <div class="step-actions">
                        <button class="btn btn-danger btn-sm" onclick="removeStep('${stepId}')">
                            Remove
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Step Question *</label>
                    <textarea class="form-control step-question" placeholder="Enter the multiple choice question for this step..." required>${stepData ? stepData.Question : ''}</textarea>
                </div>
                
                <div class="options-grid">
                    <div class="option-item">
                        <input type="radio" class="option-radio" name="correct_${stepCounter}" value="0" ${stepData && stepData.CorrectAnswerIndex === 0 ? 'checked' : ''}>
                        <input type="text" class="form-control option-input option-1" placeholder="Option 1" value="${stepData ? stepData.Option1 : ''}" required>
                    </div>
                    <div class="option-item">
                        <input type="radio" class="option-radio" name="correct_${stepCounter}" value="1" ${stepData && stepData.CorrectAnswerIndex === 1 ? 'checked' : ''}>
                        <input type="text" class="form-control option-input option-2" placeholder="Option 2" value="${stepData ? stepData.Option2 : ''}" required>
                    </div>
                    <div class="option-item">
                        <input type="radio" class="option-radio" name="correct_${stepCounter}" value="2" ${stepData && stepData.CorrectAnswerIndex === 2 ? 'checked' : ''}>
                        <input type="text" class="form-control option-input option-3" placeholder="Option 3" value="${stepData ? stepData.Option3 : ''}" required>
                    </div>
                    <div class="option-item">
                        <input type="radio" class="option-radio" name="correct_${stepCounter}" value="3" ${stepData && stepData.CorrectAnswerIndex === 3 ? 'checked' : ''}>
                        <input type="text" class="form-control option-input option-4" placeholder="Option 4" value="${stepData ? stepData.Option4 : ''}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Explanation *</label>
                    <textarea class="form-control step-explanation" placeholder="Explain why the correct answer is right..." required>${stepData ? stepData.Explanation : ''}</textarea>
                </div>
            `;
            
            elements.stepsContainer.appendChild(stepCard);
        }

        function removeStep(stepId) {
            console.log('üóëÔ∏è Removing step:', stepId);
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.remove();
                renumberSteps();
            }
        }

        function renumberSteps() {
            const stepCards = elements.stepsContainer.getElementsByClassName('step-card');
            stepCounter = 0;
            
            console.log('üî¢ Renumbering steps, count:', stepCards.length);
            
            Array.from(stepCards).forEach((card, index) => {
                stepCounter++;
                const stepNumber = card.querySelector('.step-number');
                const radioButtons = card.querySelectorAll('.option-radio');
                
                if (stepNumber) {
                    stepNumber.textContent = stepCounter;
                }
                
                radioButtons.forEach(radio => {
                    radio.name = `correct_${stepCounter}`;
                });
            });
        }

        // Data Collection
        function collectStepsData() {
            const steps = [];
            const stepCards = elements.stepsContainer.getElementsByClassName('step-card');
            
            console.log('üìã Collecting data from', stepCards.length, 'steps');
            
            Array.from(stepCards).forEach((card, index) => {
                const question = card.querySelector('.step-question').value;
                const option1 = card.querySelector('.option-1').value;
                const option2 = card.querySelector('.option-2').value;
                const option3 = card.querySelector('.option-3').value;
                const option4 = card.querySelector('.option-4').value;
                const explanation = card.querySelector('.step-explanation').value;
                
                const correctRadio = card.querySelector('.option-radio:checked');
                const correctAnswerIndex = correctRadio ? parseInt(correctRadio.value) : -1;
                
                console.log(`üìù Step ${index + 1}:`, {
                    question: question.substring(0, 50) + '...',
                    correctAnswerIndex: correctAnswerIndex,
                    hasExplanation: !!explanation
                });
                
                if (question && option1 && option2 && option3 && option4 && explanation && correctAnswerIndex !== -1) {
                    steps.push({
                        Question: question,
                        Option1: option1,
                        Option2: option2,
                        Option3: option3,
                        Option4: option4,
                        CorrectAnswerIndex: correctAnswerIndex,
                        Explanation: explanation,
                        TutorID: currentUser.tutorId // Use authenticated tutor ID
                    });
                }
            });
            
            console.log('‚úÖ Collected', steps.length, 'valid steps');
            return steps;
        }

        // Validation
        function validateHeaderForm() {
            const requiredFields = [
                'courseSelect', 'termSelect', 'topicInput', 'titleInput', 'durationInput'
            ];
            
            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    console.log('‚ùå Validation failed: Missing field', fieldId);
                    showAlert('error', `Please fill in all required fields`);
                    field.focus();
                    return false;
                }
            }
            
            console.log('‚úÖ Header form validation passed');
            return true;
        }

        function validateAllSteps() {
            const stepCards = elements.stepsContainer.getElementsByClassName('step-card');
            let allValid = true;
            
            console.log('üîç Validating', stepCards.length, 'steps');
            
            for (let card of stepCards) {
                const question = card.querySelector('.step-question').value.trim();
                const option1 = card.querySelector('.option-1').value.trim();
                const option2 = card.querySelector('.option-2').value.trim();
                const option3 = card.querySelector('.option-3').value.trim();
                const option4 = card.querySelector('.option-4').value.trim();
                const explanation = card.querySelector('.step-explanation').value.trim();
                const correctRadio = card.querySelector('.option-radio:checked');
                
                const stepValid = question && option1 && option2 && option3 && option4 && explanation && correctRadio;
                
                if (!stepValid) {
                    console.log('‚ùå Step validation failed for one or more steps');
                    allValid = false;
                    break;
                }
            }
            
            console.log('‚úÖ Steps validation:', allValid ? 'PASSED' : 'FAILED');
            return allValid;
        }

        // Delete Operation
        async function deleteSimulation(simulationId) {
            console.log('üóëÔ∏è Requesting deletion for:', simulationId);
            
            if (!confirm('Are you sure you want to delete this essay simulation? This action cannot be undone.')) {
                console.log('‚ùå Deletion cancelled by user');
                return;
            }
            
            try {
                const response = await callBackend('deleteEssaySimulation', { simulationId });
                console.log('üì¶ Delete response:', response);
                
                if (response.success) {
                    console.log('‚úÖ Simulation deleted successfully');
                    showAlert('success', response.message);
                    loadSimulations();
                } else {
                    console.error('‚ùå Delete failed:', response.error);
                    showAlert('error', `Failed to delete simulation: ${response.error}`);
                }
            } catch (error) {
                console.error('‚ùå Network error during deletion:', error);
                showAlert('error', `Network error: ${error.message}`);
            }
        }

        // Search and Filter
        function filterSimulations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            console.log('üîç Filtering simulations with term:', searchTerm);
            
            if (!searchTerm) {
                displaySimulations(allSimulations);
                return;
            }
            
            const filtered = allSimulations.filter(sim => 
                sim.SimulationID.toLowerCase().includes(searchTerm) ||
                sim.Course.toLowerCase().includes(searchTerm) ||
                sim.Topic.toLowerCase().includes(searchTerm) ||
                sim.Title.toLowerCase().includes(searchTerm) ||
                (sim.Tags && sim.Tags.toLowerCase().includes(searchTerm))
            );
            
            console.log('üìä Filter results:', filtered.length, 'simulations found');
            displaySimulations(filtered);
        }

        // Utility Functions
        function resetForm() {
            console.log('üîÑ Resetting form');
            document.getElementById('headerForm').reset();
            elements.stepsContainer.innerHTML = '';
            stepCounter = 0;
            currentEditingSimulationId = null;
        }

        function showLoading(show) {
            console.log('‚è≥ Loading state:', show);
            elements.loadingIndicator.classList.toggle('hidden', !show);
            if (show) {
                elements.simulationsTableBody.innerHTML = '';
            }
        }

        function showAlert(type, message) {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-error' : type === 'warning' ? 'alert-warning' : 'alert-success';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Backend Communication
        async function callBackend(action, data = {}, method = 'POST') {
            const url = new URL(BACKEND_URL);
            
            console.log(`üåê ${method} request to backend:`, { action, data });
            
            try {
                let response;
                
                if (method === 'GET') {
                    url.searchParams.append('action', action);
                    if (data.simulationId) {
                        url.searchParams.append('simulationId', data.simulationId);
                    }
                    
                    response = await fetch(url, { 
                        method: 'GET',
                        credentials: 'include'
                    });
                } else {
                    response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action, data }),
                        credentials: 'include'
                    });
                }
                
                const result = await response.json();
                console.log(`üì¶ Backend response for ${action}:`, result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Backend call failed:', error);
                throw error;
            }
        }

        // Make functions globally available
        window.showDashboard = showDashboard;
        window.showCreateForm = showCreateForm;
        window.showEditForm = showEditForm;
        window.saveSimulationHeader = saveSimulationHeader;
        window.saveAllSteps = saveAllSteps;
        window.addStep = addStep;
        window.removeStep = removeStep;
        window.deleteSimulation = deleteSimulation;
        window.filterSimulations = filterSimulations;
        window.checkAuthentication = checkAuthentication;

        console.log('üéâ Essay Simulation Builder frontend loaded!');
    </script>
</body>
</html>
