<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBU Tutor Platform - Essay Simulation Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--surface);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--background);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Steps Builder */
        .steps-container {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            min-height: 200px;
            background: var(--background);
        }

        .step-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s;
        }

        .step-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        .step-title {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .step-actions {
            display: flex;
            gap: 0.5rem;
        }

        .option-group {
            margin-bottom: 1rem;
        }

        .option-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }

        .option-row:hover {
            background: var(--background);
        }

        .option-row.correct {
            background: #f0fdf4;
            border-left: 3px solid var(--success);
        }

        .option-input {
            flex: 1;
        }

        .correct-option {
            color: var(--success);
            font-weight: 600;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: var(--background);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fef2f2;
            color: #991b1b;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.warning {
            background: var(--warning);
        }

        .notification.info {
            background: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .close-modal:hover {
            background: var(--background);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-light);
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                display: none;
            }
            
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>CBU Tutor Platform</span>
                </div>
                <ul class="nav-links">
                    <li><a href="#" class="active"><i class="fas fa-edit"></i> Essay Simulations</a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i> MCQ Questions</a></li>
                    <li><a href="#"><i class="fas fa-keyboard"></i> Short Answer</a></li>
                    <li><a href="#"><i class="fas fa-layer-group"></i> Flashcards</a></li>
                    <li><a href="#"><i class="fas fa-file-alt"></i> Documents</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSimulations">0</div>
                    <div class="stat-label">Total Simulations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeSimulations">0</div>
                    <div class="stat-label">Active Simulations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSteps">0</div>
                    <div class="stat-label">Total Steps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgSteps">0</div>
                    <div class="stat-label">Avg Steps/Simulation</div>
                </div>
            </div>

            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-edit"></i>
                    Essay Simulation Builder
                </h1>
                <button class="btn btn-primary" onclick="showCreateForm()">
                    <i class="fas fa-plus"></i>
                    <span>Create New Simulation</span>
                </button>
            </div>

            <!-- Simulations Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Existing Simulations</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search simulations..." style="width: 300px;">
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="simulationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Course</th>
                                <th>Term</th>
                                <th>Topic</th>
                                <th>Title</th>
                                <th>Steps</th>
                                <th>Duration</th>
                                <th>Tutor</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="simulationsTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No Simulations Found</h3>
                    <p>Create your first essay simulation to get started.</p>
                    <button class="btn btn-primary" onclick="showCreateForm()" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i>
                        Create Simulation
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Create/Edit Simulation Modal -->
    <div class="modal" id="simulationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">
                    <i class="fas fa-edit"></i>
                    <span id="modalTitleText">Create New Simulation</span>
                </h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <!-- Stage 1: Header Form -->
            <form id="headerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Course *</label>
                        <select class="form-control" id="course" required>
                            <option value="">Select Course</option>
                            <option value="BI110">BI110 - Biology</option>
                            <option value="CS110">CS110 - Computer Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Term *</label>
                        <select class="form-control" id="term" required>
                            <option value="">Select Term</option>
                            <option value="T1">Term 1</option>
                            <option value="T2">Term 2</option>
                            <option value="ALL">All Terms</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Topic *</label>
                    <input type="text" class="form-control" id="topic" required placeholder="e.g., Cell Biology, Programming Basics">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Essay Title/Prompt *</label>
                    <textarea class="form-control" id="title" rows="3" required placeholder="Enter the main essay question or prompt that students will address"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Estimated Duration (minutes) *</label>
                        <input type="number" class="form-control" id="estimatedDuration" min="5" max="180" value="25" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tutor ID *</label>
                        <select class="form-control" id="tutorId" required>
                            <option value="">Select Tutor</option>
                            <option value="T001">T001 - Dr. Sarah Johnson</option>
                            <option value="T002">T002 - Prof. James Banda</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveHeaderBtn">
                        <span>Save Header & Continue to Steps →</span>
                    </button>
                </div>
            </form>
            
            <!-- Stage 2: Steps Form (Initially Hidden) -->
            <div id="stepsForm" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Build Simulation Steps</h3>
                    <span id="currentSimulationId" style="color: var(--text-light); font-size: 0.875rem;"></span>
                </div>
                
                <div class="steps-container" id="stepsContainer">
                    <!-- Steps will be dynamically added here -->
                </div>
                
                <div style="margin: 1rem 0;">
                    <button type="button" class="btn btn-outline" onclick="addStep()">
                        <i class="fas fa-plus"></i>
                        <span>Add New Step</span>
                    </button>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="backToHeader()">
                        <i class="fas fa-arrow-left"></i>
                        Back to Header
                    </button>
                    <button type="button" class="btn btn-primary" id="saveStepsBtn" onclick="saveAllSteps()">
                        <i class="fas fa-save"></i>
                        <span>Save All Steps</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirm Deletion
                </h2>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this essay simulation? This action cannot be undone and will remove all associated steps.</p>
                <div class="simulation-info" id="deleteSimulationInfo" style="background: var(--background); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;"></div>
            </div>
            <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i>
                    <span>Delete Simulation</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Configuration
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbznJw1hdaO0ELnczRi3ra9vU6uzJWOdfBEP97yNcnPWeacgRyAJemv-DHGf_mjIWjwV/exec';
        let currentEditingSimulationId = null;
        let simulationsData = [];

        // DOM Elements
        const simulationModal = document.getElementById('simulationModal');
        const deleteModal = document.getElementById('deleteModal');
        const headerForm = document.getElementById('headerForm');
        const stepsForm = document.getElementById('stepsForm');
        const stepsContainer = document.getElementById('stepsContainer');
        const simulationsTableBody = document.getElementById('simulationsTableBody');
        const searchInput = document.getElementById('searchInput');
        const emptyState = document.getElementById('emptyState');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSimulations();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Header form submission
            headerForm.addEventListener('submit', handleHeaderSubmit);
            
            // Search functionality
            searchInput.addEventListener('input', filterSimulations);
        }

        // Modal Management
        function showCreateForm() {
            document.getElementById('modalTitleText').textContent = 'Create New Simulation';
            headerForm.reset();
            headerForm.style.display = 'block';
            stepsForm.style.display = 'none';
            currentEditingSimulationId = null;
            simulationModal.classList.add('show');
        }

        function closeModal() {
            simulationModal.classList.remove('show');
            resetForm();
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('show');
        }

        function resetForm() {
            headerForm.reset();
            headerForm.style.display = 'block';
            stepsForm.style.display = 'none';
            stepsContainer.innerHTML = '';
            currentEditingSimulationId = null;
        }

        // Header Form Submission
        async function handleHeaderSubmit(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveHeaderBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="spinner"></div> Processing...';

            const formData = {
                course: document.getElementById('course').value,
                term: document.getElementById('term').value,
                topic: document.getElementById('topic').value,
                title: document.getElementById('title').value,
                estimatedDuration: parseInt(document.getElementById('estimatedDuration').value),
                tutorId: document.getElementById('tutorId').value,
                action: currentEditingSimulationId ? 'updateSimulationHeader' : 'createSimulationHeader'
            };

            if (currentEditingSimulationId) {
                formData.simulationId = currentEditingSimulationId;
            }

            try {
                const response = await makeBackendCall(formData);
                
                if (response.success) {
                    showNotification('Header saved successfully!', 'success');
                    
                    if (response.id) {
                        currentEditingSimulationId = response.id;
                        showStepsForm(response.id);
                    }
                } else {
                    showNotification('Error saving header: ' + response.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Header & Continue to Steps →';
            }
        }

        function showStepsForm(simulationId) {
            document.getElementById('currentSimulationId').textContent = `Editing: ${simulationId}`;
            headerForm.style.display = 'none';
            stepsForm.style.display = 'block';
            
            // Add first step if empty
            if (stepsContainer.children.length === 0) {
                addStep();
            }
        }

        function backToHeader() {
            stepsForm.style.display = 'none';
            headerForm.style.display = 'block';
        }

        // Step Management
        function addStep(stepData = null) {
            const stepNumber = stepsContainer.children.length + 1;
            const stepId = `step_${Date.now()}`;
            
            const stepHTML = `
                <div class="step-card" id="${stepId}">
                    <div class="step-header">
                        <div class="step-title">
                            <div class="step-number">${stepNumber}</div>
                            <strong>Step ${stepNumber}</strong>
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-outline btn-sm" onclick="moveStepUp('${stepId}')" ${stepNumber === 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="moveStepDown('${stepId}')" ${stepNumber === stepsContainer.children.length + 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStep('${stepId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Question *</label>
                        <textarea class="form-control step-question" required placeholder="Enter the step question that guides essay development">${stepData ? stepData.question : ''}</textarea>
                    </div>
                    
                    <div class="option-group">
                        <label class="form-label">Options * <small>(Select the correct answer)</small></label>
                        ${[0, 1, 2, 3].map(i => `
                            <div class="option-row ${stepData && stepData.correctAnswerIndex === i ? 'correct' : ''}" id="option_${stepId}_${i}">
                                <input type="radio" name="correct_${stepId}" value="${i}" class="correct-option-radio" 
                                    ${stepData && stepData.correctAnswerIndex === i ? 'checked' : ''}
                                    onchange="updateOptionStyle('${stepId}', ${i})">
                                <input type="text" class="form-control option-input step-option" data-index="${i}" 
                                    value="${stepData ? stepData.options[i] : ''}" 
                                    required placeholder="Option ${i + 1}"
                                    oninput="updateOptionStyle('${stepId}', ${i})">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Explanation *</label>
                        <textarea class="form-control step-explanation" required placeholder="Explain why the correct answer is the best choice">${stepData ? stepData.explanation : ''}</textarea>
                    </div>
                </div>
            `;
            
            stepsContainer.insertAdjacentHTML('beforeend', stepHTML);
            updateStepNumbers();
        }

        function updateOptionStyle(stepId, optionIndex) {
            const optionRow = document.getElementById(`option_${stepId}_${optionIndex}`);
            const radio = optionRow.querySelector('.correct-option-radio');
            
            // Remove correct class from all options in this step
            for (let i = 0; i < 4; i++) {
                const row = document.getElementById(`option_${stepId}_${i}`);
                if (row) row.classList.remove('correct');
            }
            
            // Add correct class to selected option
            if (radio.checked) {
                optionRow.classList.add('correct');
            }
        }

        function removeStep(stepId) {
            const stepElement = document.getElementById(stepId);
            if (stepElement && stepsContainer.children.length > 1) {
                stepElement.remove();
                updateStepNumbers();
            } else {
                showNotification('Cannot remove the only step', 'warning');
            }
        }

        function moveStepUp(stepId) {
            const stepElement = document.getElementById(stepId);
            const prevElement = stepElement.previousElementSibling;
            if (prevElement) {
                stepsContainer.insertBefore(stepElement, prevElement);
                updateStepNumbers();
            }
        }

        function moveStepDown(stepId) {
            const stepElement = document.getElementById(stepId);
            const nextElement = stepElement.nextElementSibling;
            if (nextElement) {
                stepsContainer.insertBefore(nextElement, stepElement);
                updateStepNumbers();
            }
        }

        function updateStepNumbers() {
            const steps = stepsContainer.querySelectorAll('.step-card');
            steps.forEach((step, index) => {
                const stepNumber = step.querySelector('.step-number');
                const stepText = step.querySelector('.step-title strong');
                stepNumber.textContent = index + 1;
                stepText.textContent = `Step ${index + 1}`;
                
                // Update move buttons
                const moveUpBtn = step.querySelector('button[onclick*="moveStepUp"]');
                const moveDownBtn = step.querySelector('button[onclick*="moveStepDown"]');
                moveUpBtn.disabled = index === 0;
                moveDownBtn.disabled = index === steps.length - 1;
            });
        }

        // Save All Steps
        async function saveAllSteps() {
            const saveBtn = document.getElementById('saveStepsBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="spinner"></div> Saving Steps...';

            const steps = [];
            const stepElements = stepsContainer.querySelectorAll('.step-card');
            let isValid = true;

            stepElements.forEach((stepElement, index) => {
                const question = stepElement.querySelector('.step-question').value.trim();
                const explanation = stepElement.querySelector('.step-explanation').value.trim();
                const options = [];
                const optionInputs = stepElement.querySelectorAll('.step-option');
                
                let correctAnswerIndex = -1;
                const radioButtons = stepElement.querySelectorAll('.correct-option-radio');
                
                radioButtons.forEach((radio, i) => {
                    if (radio.checked) {
                        correctAnswerIndex = i;
                    }
                });

                optionInputs.forEach(input => {
                    options.push(input.value.trim());
                });

                // Validation
                if (!question || !explanation || options.some(opt => !opt) || correctAnswerIndex === -1) {
                    isValid = false;
                    showNotification(`Please fill all fields in Step ${index + 1}`, 'error');
                    return;
                }

                steps.push({
                    stepNumber: index + 1,
                    question,
                    options,
                    correctAnswerIndex,
                    explanation
                });
            });

            if (!isValid || steps.length === 0) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save All Steps';
                return;
            }

            const payload = {
                action: 'saveSimulationSteps',
                simulationId: currentEditingSimulationId,
                steps: steps
            };

            try {
                const response = await makeBackendCall(payload);
                
                if (response.success) {
                    showNotification(`Successfully saved ${response.stepsCreated} steps!`, 'success');
                    closeModal();
                    loadAllSimulations();
                } else {
                    showNotification('Error saving steps: ' + response.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save All Steps';
            }
        }

        // Load and Display Simulations
        async function loadAllSimulations() {
            try {
                showNotification('Loading simulations...', 'info');
                const response = await makeBackendCall({ action: 'getAllEssaySimulations' });
                
                if (response.success) {
                    simulationsData = response.data;
                    displaySimulations(simulationsData);
                    updateStats(simulationsData);
                    showNotification(`Loaded ${simulationsData.length} simulations`, 'success');
                } else {
                    showNotification('Error loading simulations: ' + response.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        function displaySimulations(simulations) {
            simulationsTableBody.innerHTML = '';
            
            if (simulations.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            simulations.forEach(sim => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${sim.SimulationID}</strong></td>
                    <td>${sim.Course}</td>
                    <td>${sim.Term}</td>
                    <td>${sim.Topic}</td>
                    <td title="${sim.Title}">${sim.Title.length > 50 ? sim.Title.substring(0, 50) + '...' : sim.Title}</td>
                    <td>${sim.TotalSteps || 0}</td>
                    <td>${sim.EstimatedDuration}m</td>
                    <td>${sim.TutorID}</td>
                    <td>
                        <span class="status-badge ${sim.IsActive ? 'status-active' : 'status-inactive'}">
                            ${sim.IsActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editSimulation('${sim.SimulationID}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="showDeleteConfirmation('${sim.SimulationID}')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </td>
                `;
                simulationsTableBody.appendChild(row);
            });
        }

        function updateStats(simulations) {
            const totalSimulations = simulations.length;
            const activeSimulations = simulations.filter(sim => sim.IsActive).length;
            const totalSteps = simulations.reduce((sum, sim) => sum + (sim.TotalSteps || 0), 0);
            const avgSteps = totalSimulations > 0 ? (totalSteps / totalSimulations).toFixed(1) : 0;
            
            document.getElementById('totalSimulations').textContent = totalSimulations;
            document.getElementById('activeSimulations').textContent = activeSimulations;
            document.getElementById('totalSteps').textContent = totalSteps;
            document.getElementById('avgSteps').textContent = avgSteps;
        }

        function filterSimulations() {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = simulationsData.filter(sim => 
                sim.SimulationID.toLowerCase().includes(searchTerm) ||
                sim.Course.toLowerCase().includes(searchTerm) ||
                sim.Topic.toLowerCase().includes(searchTerm) ||
                sim.Title.toLowerCase().includes(searchTerm) ||
                sim.TutorID.toLowerCase().includes(searchTerm)
            );
            displaySimulations(filtered);
        }

        // Edit Simulation
        async function editSimulation(simulationId) {
            try {
                showNotification('Loading simulation data...', 'info');
                const response = await makeBackendCall({ 
                    action: 'getEssaySimulationById', 
                    simulationId: simulationId 
                });
                
                if (response.success) {
                    const simulation = response.data;
                    
                    // Populate header form
                    document.getElementById('course').value = simulation.header.Course;
                    document.getElementById('term').value = simulation.header.Term;
                    document.getElementById('topic').value = simulation.header.Topic;
                    document.getElementById('title').value = simulation.header.Title;
                    document.getElementById('estimatedDuration').value = simulation.header.EstimatedDuration;
                    document.getElementById('tutorId').value = simulation.header.TutorID;
                    
                    // Clear and populate steps
                    stepsContainer.innerHTML = '';
                    simulation.steps.forEach(step => {
                        addStep({
                            question: step.Question,
                            options: [step.Option1, step.Option2, step.Option3, step.Option4],
                            correctAnswerIndex: step.CorrectAnswerIndex,
                            explanation: step.Explanation
                        });
                    });
                    
                    // Show modal in edit mode
                    document.getElementById('modalTitleText').textContent = 'Edit Simulation';
                    currentEditingSimulationId = simulationId;
                    simulationModal.classList.add('show');
                    showStepsForm(simulationId);
                    
                    showNotification('Simulation loaded successfully', 'success');
                } else {
                    showNotification('Error loading simulation: ' + response.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            }
        }

        // Delete Simulation
        let simulationToDelete = null;

        function showDeleteConfirmation(simulationId) {
            const simulation = simulationsData.find(sim => sim.SimulationID === simulationId);
            if (simulation) {
                simulationToDelete = simulationId;
                document.getElementById('deleteSimulationInfo').innerHTML = `
                    <strong>${simulation.SimulationID}</strong><br>
                    ${simulation.Course} - ${simulation.Term}<br>
                    <strong>Topic:</strong> ${simulation.Topic}<br>
                    <strong>Title:</strong> ${simulation.Title}<br>
                    <strong>Steps:</strong> ${simulation.TotalSteps || 0}<br>
                    <strong>Duration:</strong> ${simulation.EstimatedDuration} minutes
                `;
                deleteModal.classList.add('show');
            }
        }

        async function confirmDelete() {
            if (!simulationToDelete) return;

            const deleteBtn = document.getElementById('confirmDeleteBtn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<div class="spinner"></div> Deleting...';

            try {
                const response = await makeBackendCall({ 
                    action: 'deleteEssaySimulation', 
                    simulationId: simulationToDelete 
                });
                
                if (response.success) {
                    showNotification('Simulation deleted successfully', 'success');
                    closeDeleteModal();
                    loadAllSimulations();
                } else {
                    showNotification('Error deleting simulation: ' + response.error, 'error');
                }
            } catch (error) {
                showNotification('Network error: ' + error.message, 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete Simulation';
                simulationToDelete = null;
            }
        }

        // Backend Communication
        async function makeBackendCall(payload) {
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Backend call failed:', error);
                throw error;
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${icons[type] || 'fas fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    </script>
</body>
</html>        label { display: block; margin-bottom: 8px; color: var(--accent-color); font-weight: 500; }
        input[type="text"], select, textarea, input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; background-color: var(--primary-bg); color: var(--primary-text);
            font-size: 1em; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary-action);
            box-shadow: 0 0 5px rgba(0,123,255,0.5);
        }
        textarea { resize: vertical; min-height: 80px; }
        .option-group {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: #1b263b; border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 10px;
        }
        .option-group input[type="text"] { flex: 1; margin: 0; border: none; background-color: transparent; padding: 0;}
        .option-group input[type="radio"] { flex-shrink: 0; transform: scale(1.2); cursor: pointer;}
        button {
            border: none; padding: 12px 25px; font-size: 1em; cursor: pointer;
            border-radius: 8px; transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        button:disabled { background-color: #6c757d !important; cursor: not-allowed; transform: none !important; }
        .btn-primary { background-color: var(--primary-action); color: white; }
        .btn-primary:hover { background-color: var(--primary-action-hover); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #212529; }
        .action-button-group { text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; }
        .action-btn { padding: 6px 12px; font-size: 0.9em; }
        .step-item {
            background: #1b263b; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            border-left: 4px solid var(--accent-color); animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-item h4 {
            color: var(--accent-color); margin-top: 0; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: var(--primary-bg); min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #2b3a55; color: var(--accent-color); font-weight: 600; }
        tr:hover { background-color: #2b3a55; }
        .table-actions { display: flex; gap: 8px; }
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            width: 100%; max-width: 350px;
        }
        .notification {
            color: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0;
            transform: translateX(100%); transition: all 0.5s ease-in-out;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.warning { background-color: var(--warning-color); color: #333; }
        .validation-error { border-color: var(--danger-color) !important; }
        .validation-message { color: var(--danger-color); font-size: 0.85em; margin-top: 5px; }
        @media (max-width: 768px) {
            .admin-container { padding: 20px; }
            table { min-width: 100%; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid var(--border-color); margin-bottom: 10px; border-radius: 8px; background: #1b263b; padding: 10px; }
            td { border: none; border-bottom: 1px solid var(--primary-bg); position: relative; padding-left: 50%; text-align: right; word-wrap: break-word; }
            td:last-child { border-bottom: 0; }
            td::before {
                content: attr(data-label); position: absolute; left: 6px; width: 45%;
                padding-right: 10px; white-space: nowrap; text-align: left;
                font-weight: bold; color: var(--accent-color);
            }
            .table-actions { justify-content: flex-end; margin-top: 10px; }
            .action-button-group { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="notification-container"></div>
    <div class="admin-container">
        <h1>Essay Simulation Builder</h1>

        <!-- STAGE 1: Header Metadata Form -->
        <div id="headerFormSection" class="form-section">
            <h2>1. Simulation Details (Metadata)</h2>
            <form id="headerForm">
                <input type="hidden" id="es-simulation-id" name="SimulationID">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="course">Course</label>
                        <input type="text" id="course" name="Course" required placeholder="e.g., BI110">
                        <div class="validation-message" id="course-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="term">Term</label>
                        <input type="text" id="term" name="Term" required placeholder="e.g., T1">
                        <div class="validation-message" id="term-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="topic">Topic</label>
                        <input type="text" id="topic" name="Topic" required placeholder="e.g., CELL BIOLOGY">
                        <div class="validation-message" id="topic-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="tutorId">Tutor ID</label>
                        <input type="text" id="tutorId" name="TutorID" required placeholder="e.g., T001">
                        <div class="validation-message" id="tutorId-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="estimatedDuration">Est. Duration (Mins)</label>
                        <input type="number" id="estimatedDuration" name="EstimatedDuration" min="5" value="25" required>
                        <div class="validation-message" id="duration-error"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="title">Essay Prompt/Title</label>
                    <textarea id="title" name="Title" rows="3" required placeholder="Enter the main essay question..."></textarea>
                    <div class="validation-message" id="title-error"></div>
                </div>
                <div class="action-button-group">
                    <button type="submit" id="saveHeaderBtn" class="btn-primary">Save Header & Continue to Steps &rarr;</button>
                </div>
            </form>
        </div>

        <!-- STAGE 2: Step Editor -->
        <div id="stepsFormSection" class="form-section" style="display: none;">
            <h2>Editing Steps for Simulation ID: <span id="currentSimIdDisplay" style="color: var(--accent-color);"></span></h2>
            <div id="stepsContainer"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn-success" onclick="addStep()">+ Add New Step</button>
            </div>
            <div class="action-button-group">
                <button type="button" id="saveStepsBtn" class="btn-primary" onclick="saveAllSteps(event)">💾 Save All Steps</button>
                <button type="button" id="cancelEditBtn" class="btn-warning" onclick="resetForm()">Cancel / New Simulation</button>
            </div>
        </div>

        <!-- Bulk Upload Section -->
        <div class="form-section">
            <h2>Bulk Upload Simulations</h2>
            <div class="form-grid" style="align-items: center; grid-template-columns: 2fr 1fr;">
                <input type="file" id="bulkUploadFile" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                <button type="button" class="btn-success" onclick="handleBulkUpload()">Process File</button>
            </div>
        </div>

        <!-- Management Table -->
        <div class="form-section">
            <h2>Existing Essay Simulations</h2>
            <input type="text" id="searchSimulations" onkeyup="filterSimulations()" placeholder="Search by ID, Course, or Title..." style="margin-bottom: 20px;">
            <div class="table-container">
                <table id="simulationsTable">
                    <thead><tr><th>ID</th><th>Title</th><th>Course/Term</th><th>Topic</th><th>Steps</th><th>Duration</th><th>Tutor</th><th>Actions</th></tr></thead>
                    <tbody id="simulationsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
// ===================================================================================
// --- CBU Tutor Platform: HYBRID Essay Simulation Admin JavaScript (LIVE VERSION) ---
// ===================================================================================

const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbzG_Qf1w2vVeRCGMqc8CyEXW1LIMjnwVy0n6DF4qP3li9QMdviUxCzYaNBmn9o7O4N8/exec'; // REPLACE WITH REAL URL

let currentEditingSimulationId = null;

// === CORE API & UTILITIES ===
async function callApi(requestData, element = null) {
    if (APPS_SCRIPT_API_URL.includes('YOUR_DEPLOYED')) {
        showNotification('ERROR: API URL is not configured.', 'error');
        return { status: 'ERROR', message: 'API URL not configured.' };
    }
    
    let originalButtonText;
    if (element && element.tagName === 'BUTTON') {
        originalButtonText = element.innerText;
        element.disabled = true; element.innerText = 'Processing...';
    }

    try {
        const response = await fetch(APPS_SCRIPT_API_URL, {
            method: 'POST', body: JSON.stringify(requestData),
            headers: { 'Content-Type': 'application/json' }, mode: 'cors'
        });
        if (!response.ok) throw new Error(`Network Error: ${response.statusText}`);
        return await response.json();
    } catch (error) {
        console.error('API Call Failed:', error);
        showNotification(`API Error: ${error.message}`, 'error');
        return { status: 'ERROR', message: error.message };
    } finally {
        if (element && element.tagName === 'BUTTON') {
            element.disabled = false; element.innerText = originalButtonText;
        }
    }
}

function showNotification(message, type = 'success') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    container.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => container.removeChild(notification), 500);
    }, 5000);
}

function clearValidationErrors() {
    document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));
    document.querySelectorAll('.validation-message').forEach(el => el.textContent = '');
}

function showValidationError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}-error`);
    if (field) field.classList.add('validation-error');
    if (errorElement) errorElement.textContent = message;
}

// === MANAGEMENT TABLE ===
async function loadSimulations() {
    const tableBody = document.getElementById('simulationsTableBody');
    tableBody.innerHTML = '<tr><td colspan="8">Loading simulations...</td></tr>';
    const response = await callApi({ action: 'GET_ALL_SIMULATIONS' });
    
    if (response.status === 'SUCCESS' && Array.isArray(response.data)) {
        renderManagementTable(response.data);
    } else {
        tableBody.innerHTML = `<tr><td colspan="8">Failed to load data. ${response.message || ''}</td></tr>`;
    }
}

function renderManagementTable(simulations) {
    const tableBody = document.getElementById('simulationsTableBody');
    const headers = Array.from(document.querySelectorAll('#simulationsTable th')).map(th => th.textContent);
    
    if (simulations.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No simulations found. Create one.</td></tr>`;
        return;
    }

    tableBody.innerHTML = simulations.map(sim => `
        <tr data-id="${sim.SimulationID}">
            <td data-label="${headers[0]}">${sim.SimulationID}</td>
            <td data-label="${headers[1]}">${sim.Title.substring(0, 40)}...</td>
            <td data-label="${headers[2]}">${sim.Course}/${sim.Term}</td>
            <td data-label="${headers[3]}">${sim.Topic || 'N/A'}</td>
            <td data-label="${headers[4]}">${sim.stepCount || 0}</td>
            <td data-label="${headers[5]}">${sim.EstimatedDuration || 25}m</td>
            <td data-label="${headers[6]}">${sim.TutorID}</td>
            <td data-label="${headers[7]}">
                <div class="table-actions">
                    <button class="action-btn btn-warning" onclick="editSimulation('${sim.SimulationID}')">Edit</button>
                    <button class="action-btn btn-danger" onclick="deleteSimulation('${sim.SimulationID}')">Delete</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterSimulations() {
    const term = document.getElementById('searchSimulations').value.toLowerCase();
    const rows = document.querySelectorAll('#simulationsTableBody tr');
    rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
}

// === WORKFLOW: CREATION & EDITING ===
async function handleHeaderSubmit(event) {
    event.preventDefault();
    const form = event.target;
    
    clearValidationErrors();
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.action = 'CREATE_SIMULATION_HEADER';

    // Basic validation
    let isValid = true;
    if (!data.Course) { showValidationError('course', 'Course is required'); isValid = false; }
    if (!data.Term) { showValidationError('term', 'Term is required'); isValid = false; }
    if (!data.Topic) { showValidationError('topic', 'Topic is required'); isValid = false; }
    if (!data.TutorID) { showValidationError('tutorId', 'Tutor ID is required'); isValid = false; }
    if (!data.Title) { showValidationError('title', 'Essay prompt is required'); isValid = false; }
    
    if (!isValid) {
        showNotification('Please fix validation errors', 'warning');
        return;
    }

    const response = await callApi(data, form.querySelector('button[type="submit"]'));
    
    if (response.status === 'SUCCESS' && response.data.simulationId) {
        showNotification('Header saved. You can now add steps.', 'success');
        showStepsForm(response.data.simulationId);
    } else {
        showNotification(response.message || 'Failed to save header.', 'error');
    }
}

function showStepsForm(simulationId) {
    currentEditingSimulationId = simulationId;
    document.getElementById('headerFormSection').classList.add('disabled-section');
    document.getElementById('currentSimIdDisplay').textContent = simulationId;
    document.getElementById('stepsFormSection').style.display = 'block';
    
    if (document.getElementById('stepsContainer').children.length === 0) {
        addStep();
    }
    document.getElementById('stepsFormSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function addStep(stepData = {}) {
    const uniqueIndex = Date.now() + Math.random().toString(36).substr(2, 9);
    const container = document.getElementById('stepsContainer');
    const data = { 
        Question: '', Option1: '', Option2: '', Option3: '', Option4: '', 
        CorrectAnswerIndex: '', Explanation: '', TutorID: '', ...stepData 
    };
    const isChecked = (optIndex) => String(data.CorrectAnswerIndex) === String(optIndex) ? 'checked' : '';

    const stepHtml = `
        <div class="step-item" id="step-item-${uniqueIndex}" data-unique-index="${uniqueIndex}">
            <h4><span class="step-title">Step</span><button type="button" class="action-btn btn-danger" onclick="removeStep('${uniqueIndex}')">Delete</button></h4>
            <div class="form-group">
                <label>Step Question</label>
                <textarea class="step-question" required>${data.Question}</textarea>
            </div>
            <div class="form-grid">
                ${[1,2,3,4].map(i => `
                <div class="form-group">
                    <label>Option ${i}</label>
                    <div class="option-group">
                        <input type="radio" name="correctAnswer-${uniqueIndex}" value="${i-1}" ${isChecked(i-1)} required>
                        <input type="text" class="step-option${i}" value="${data['Option'+i]}" required>
                    </div>
                </div>`).join('')}
            </div>
            <div class="form-group">
                <label>Explanation</label>
                <textarea class="step-explanation" required>${data.Explanation || ''}</textarea>
            </div>
            <div class="form-group">
                <label>Tutor ID</label>
                <input type="text" class="step-tutor" value="${data.TutorID || document.getElementById('tutorId').value}" required>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', stepHtml);
    reindexStepsUI();
}

function removeStep(uniqueIndex) {
    if (document.querySelectorAll('#stepsContainer .step-item').length <= 1) {
        showNotification('A simulation must have at least one step.', 'warning');
        return;
    }
    document.getElementById(`step-item-${uniqueIndex}`)?.remove();
    reindexStepsUI();
}

function reindexStepsUI() {
    document.querySelectorAll('#stepsContainer .step-item .step-title').forEach((title, index) => {
        title.textContent = `Step ${index + 1}`;
    });
}

async function saveAllSteps(event) {
    if (!currentEditingSimulationId) { 
        showNotification('No active Simulation ID. Please save a header first.', 'error'); 
        return; 
    }
    
    const stepItems = document.querySelectorAll('#stepsContainer .step-item');
    if (stepItems.length === 0) { 
        showNotification('A simulation must have at least one step.', 'error'); 
        return; 
    }
    
    let steps = [];
    let validationError = false;
    
    stepItems.forEach((item, index) => {
        if (validationError) return;
        
        const uniqueIndex = item.getAttribute('data-unique-index');
        const checkedRadio = item.querySelector(`input[name="correctAnswer-${uniqueIndex}"]:checked`);
        
        if (!checkedRadio) {
            showNotification(`Step ${index + 1} is missing a correct answer.`, 'error');
            validationError = true; 
            return;
        }
        
        steps.push({
            Question: item.querySelector('.step-question').value.trim(),
            Option1: item.querySelector('.step-option1').value.trim(),
            Option2: item.querySelector('.step-option2').value.trim(),
            Option3: item.querySelector('.step-option3').value.trim(),
            Option4: item.querySelector('.step-option4').value.trim(),
            CorrectAnswerIndex: parseInt(checkedRadio.value, 10),
            Explanation: item.querySelector('.step-explanation').value.trim(),
            TutorID: item.querySelector('.step-tutor').value.trim()
        });
    });

    if (validationError) return;
    
    const payload = { action: 'SAVE_SIMULATION_STEPS', simulationId: currentEditingSimulationId, steps: steps };
    const response = await callApi(payload, event.target);

    if (response.status === 'SUCCESS') {
        showNotification(`${steps.length} steps saved successfully!`, 'success');
        resetForm();
        loadSimulations();
    } else {
        showNotification(response.message || 'Failed to save steps.', 'error');
    }
}

// === WORKFLOW: EDIT, DELETE, RESET & BULK UPLOAD ===
async function editSimulation(simulationId) {
    showNotification(`Loading simulation ${simulationId} for editing...`, 'warning');
    const response = await callApi({ action: 'GET_SIMULATION_BY_ID', simulationId });

    if (response.status === 'SUCCESS' && response.data) {
        const { header, steps } = response.data;
        const headerForm = document.getElementById('headerForm');
        
        // Populate header form
        document.getElementById('es-simulation-id').value = header.SimulationID;
        document.getElementById('course').value = header.Course;
        document.getElementById('term').value = header.Term;
        document.getElementById('topic').value = header.Topic;
        document.getElementById('tutorId').value = header.TutorID;
        document.getElementById('estimatedDuration').value = header.EstimatedDuration;
        document.getElementById('title').value = header.Title;
        
        document.getElementById('stepsContainer').innerHTML = '';
        showStepsForm(header.SimulationID);
        
        if (steps && steps.length > 0) {
            steps.forEach(step => addStep(step));
        } else {
            addStep();
        }
        showNotification('Simulation loaded for editing.', 'success');
    } else {
        showNotification(response.message || 'Could not load simulation data.', 'error');
    }
}

async function deleteSimulation(simulationId) {
    if (confirm(`DELETE Simulation ${simulationId} and ALL its steps? This cannot be undone.`)) {
        const response = await callApi({ action: 'DELETE_SIMULATION', simulationId });
        if (response.status === 'SUCCESS') {
            showNotification(response.message, 'success');
            if (currentEditingSimulationId === simulationId) resetForm();
            loadSimulations();
        } else {
            showNotification(response.message || 'Failed to delete simulation.', 'error');
        }
    }
}

function resetForm() {
    currentEditingSimulationId = null;
    document.getElementById('headerForm').reset();
    document.getElementById('stepsContainer').innerHTML = '';
    document.getElementById('headerFormSection').classList.remove('disabled-section');
    document.getElementById('stepsFormSection').style.display = 'none';
    clearValidationErrors();
}

function handleBulkUpload() {
    const fileInput = document.getElementById('bulkUploadFile');
    const file = fileInput.files[0];
    if (!file) { showNotification('Please select a file first.', 'warning'); return; }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const encodedData = btoa(e.target.result);
        showNotification(`Processing ${file.name}...`, 'warning');
        const payload = { action: 'BULK_UPLOAD_SIMULATIONS', encodedData, fileName: file.name };
        const response = await callApi(payload);
        
        fileInput.value = '';
        if (response.status === 'SUCCESS') {
            loadSimulations();
            let msg = `Bulk upload complete: ${response.data.successful} imported.`;
            if (response.data.failed > 0) msg += ` ${response.data.failed} failed.`;
            showNotification(msg, response.data.failed > 0 ? 'warning' : 'success');
        } else {
            showNotification('Bulk upload failed: ' + response.message, 'error');
        }
    };
    reader.onerror = () => showNotification('Error reading file.', 'error');
    reader.readAsBinaryString(file);
}

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', () => {
    loadSimulations();
    document.getElementById('headerForm').addEventListener('submit', handleHeaderSubmit);
});
</script>
</body>
</html>
